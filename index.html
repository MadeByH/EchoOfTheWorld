<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Topâ€‘Down 3D World Game (Final Fix - V6)</title>
<style>
html,body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: #000000; 
  width: 100vw;
  height: 100vh;
}

#game {
  position: relative;
  width: 100%;
  height: 100%;
  perspective: 1000px; 
  overflow: hidden;
}

#world {
  position: absolute;
  width: 30000px; 
  height: 30000px;
  background: repeating-linear-gradient(45deg, #4caf50 0 80px, #43a047 80px 160px);
  
  /* Ù…Ø±Ú©Ø² Ø¯Ù†ÛŒØ§ Ø±Ø§ Ø¯Ø± Ù…Ø®ØªØµØ§Øª ØµÙØ­Ù‡ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… */
  left: calc(50% - 15000px);
  top: calc(50% - 15000px);
  
  transform-origin: 50% 50%;
  transform: rotateX(60deg); 
}

.tile {
  position: absolute;
  width: 150px;
  height: 150px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.15);
}

#player {
  position: absolute; 
  width: 60px;
  height: 60px;
  background: url('https://cdn-icons-png.flaticon.com/512/4140/4140048.png') center/contain no-repeat;
  
  /* **ØªØºÛŒÛŒØ± Ø§ØµÙ„ÛŒ:** ØªÙ†Ø¸ÛŒÙ… Ù…Ø®ØªØµØ§Øª Ù…Ø·Ù„Ù‚ Ø¨Ù‡ Ù…Ø±Ú©Ø² Ù‡Ù†Ø¯Ø³ÛŒ 30000x30000 */
  left: 15000px; 
  top: 15000px;  
  
  z-index: 100; 
  transform-origin: 30px 30px; 
  transform: rotateZ(0deg); 
  transition: transform 0.05s linear;
  
  /* **ØªØ³Øª Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ:** Ø§Ú¯Ø± Ù‡Ù…Ú†Ù†Ø§Ù† Ø¯ÛŒØ¯Ù‡ Ù†Ø´Ø¯ØŒ Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨Ø¨ÛŒÙ†ÛŒÙ… Ù…Ø´Ú©Ù„ Ø§Ø² Ø®ÙˆØ¯ ØªØµÙˆÛŒØ± Ø§Ø³Øª ÛŒØ§ Ø§Ø² ØªØ±Ù†Ø³ÙÙˆØ±Ù… */
  /* background-color: red !important; */
}

/* Ø¬ÙˆÛŒâ€ŒØ§Ø³ØªÛŒÚ© (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) */
#joystick {
  position: fixed;
  bottom: 40px;
  left: 40px;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.15);
  border: 2px solid rgba(255, 255, 255, 0.4);
  touch-action: none;
  z-index: 200;
}
#stick {
  position: absolute;
  top: 45px;
  left: 45px;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: rgba(255,255,255,0.9);
  pointer-events: none;
}
</style>
</head>

<body>
<div id="game">
  <div id="world">
    <!-- Ú©Ø§Ø´ÛŒâ€ŒÙ‡Ø§ÛŒ ØªØ³ØªÛŒ Ø¯Ø± Ù…Ø±Ú©Ø² (Û±ÛµÛ°Û°Û°, Û±ÛµÛ°Û°Û°) -->
    <div class="tile" style="top: 14950px; left: 14950px;"></div>
    <div class="tile" style="top: 14950px; left: 15100px;"></div>
    <div class="tile" style="top: 15100px; left: 14950px;"></div>
    <div class="tile" style="top: 15100px; left: 15100px;"></div>
    
    <!-- Ú©Ø§Ø´ÛŒâ€ŒÙ‡Ø§ÛŒ ØªØ³Øª ÙØ§ØµÙ„Ù‡ Ø¯ÙˆØ± -->
    <div class="tile" style="top: 5000px; left: 5000px;"></div>
    <div class="tile" style="top: 20000px; left: 25000px;"></div>
  </div>
  <div id="player"></div>
</div>

<div id="joystick">
  <div id="stick"></div>
</div>

<script>
const player = document.getElementById('player');
const world = document.getElementById('world');
const joystick = document.getElementById('joystick');
const stick = document.getElementById('stick');

let joyActive = false;
let center = {x: 0, y: 0};
let delta = {x: 0, y: 0};
let joyRadius = 40;
let velocity = {x: 0, y: 0};
let speed = 10; 

// Ù…Ø®ØªØµØ§Øª Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¯Ø± Ø¯Ù†ÛŒØ§ÛŒ 30000x30000
let playerPos = {x: 15000, y: 15000}; 
const WORLD_SIZE = 30000;

// ğŸŒ Ù…Ù†Ø·Ù‚ Ø¬ÙˆÛŒâ€ŒØ§Ø³ØªÛŒÚ©
joystick.addEventListener('touchstart', (e) => {
  e.preventDefault();
  joyActive = true;
  const rect = joystick.getBoundingClientRect();
  center.x = rect.left + rect.width / 2;
  center.y = rect.top + rect.height / 2;
});

joystick.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if (!joyActive) return;
  let t = e.touches[0];
  delta.x = t.clientX - center.x;
  delta.y = t.clientY - center.y;
  const dist = Math.sqrt(delta.x**2 + delta.y**2);
  const angle = Math.atan2(delta.y, delta.x);
  
  if (dist > joyRadius) {
    delta.x = Math.cos(angle) * joyRadius;
    delta.y = Math.sin(angle) * joyRadius;
  }
  stick.style.transform = `translate(${delta.x}px, ${delta.y}px)`;
  
  velocity.x = (delta.x / joyRadius) * speed;
  velocity.y = (delta.y / joyRadius) * speed;
});

joystick.addEventListener('touchend', () => {
  joyActive = false;
  stick.style.transform = `translate(0px, 0px)`;
  velocity = {x: 0, y: 0};
});

// ğŸï¸ Ø­Ù„Ù‚Ù‡ Ø­Ø±Ú©ØªÛŒ ÙØ±ÛŒÙ… Ø¨Ù‡ ÙØ±ÛŒÙ…
function loop() {
  
  // 1. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒÚ©Ù† Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø±Ú©Øª Ø¯Ù†ÛŒØ§
  if (velocity.x !== 0 || velocity.y !== 0) {
      playerPos.x += velocity.x; 
      playerPos.y += velocity.y; 
  }

  const dx_world = playerPos.x - (WORLD_SIZE / 2); 
  const dy_world = playerPos.y - (WORLD_SIZE / 2); 

  world.style.transform = `
      rotateX(60deg)
      translateX(${-dx_world}px) 
      translateY(${-dy_world}px) 
  `;

  // 2. ØªÙ†Ø¸ÛŒÙ… Ø²Ø§ÙˆÛŒÙ‡ Ú©Ø§Ø±Ø§Ú©ØªØ± (ÙÙ‚Ø· Ú†Ø±Ø®Ø´ Z)
  let angleDeg = 0;
  if (velocity.x !== 0 || velocity.y !== 0) {
    angleDeg = Math.atan2(-velocity.y, velocity.x) * 180 / Math.PI;
  }
  
  player.style.transform = `
    rotateZ(${angleDeg}deg)
  `;

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
